---
title: "SVMmodel98 and probability plot"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, warning=FALSE, message=FALSE}
library(ampir)
library(caret)
library(tidyverse)
library(ggplot2)
library(pROC)
```

```{r read_and_prepare_data, eval=FALSE}
set.seed(396)
#read data
tg98 <- read_faa("tmpdata/amps_sp_ampdbs98.fasta")
tg98$Label <- "Tg"
bg98 <- read_faa("tmpdata/swissprot_all_MAY98.fasta")
bg98$Label <- "Bg"
#remove rows in bg that are in tg
bg98 <- bg98[!bg98$seq.aa %in% tg98$seq.aa,]
#remove nonstandard amino acids
tg98 <- remove_nonstandard_aa(tg98)
bg98 <- remove_nonstandard_aa(bg98)
#remove sequences shorter than 20 amino acids
tg98 <- tg98[nchar(tg98$seq.aa) >=20,]
bg98 <- bg98[nchar(bg98$seq.aa) >=20,]
#select the same number of rows as tg so databases are 1:1
bg98 <- bg98[sample(nrow(bg98),4981),]
#bind target and background datasets
bg_tg98 <- rbind(bg98, tg98)
#remove rownames
rownames(bg_tg98) <- NULL
#calculate features
features98 <- calculate_features(bg_tg98)
#add Label column for y variable
features98$Label <- bg_tg98$Label
#convert to factor
features98[["Label"]] <- factor(features98[["Label"]])
```

```{r train_model, eval=FALSE}
trainIndex <-createDataPartition(y=features98$Label, p=.8, list = FALSE)
features98Train <-features98[trainIndex,]
features98Test <-features98[-trainIndex,]

trctrl_prob <- trainControl(method = "repeatedcv", number = 10, repeats = 3, classProbs = TRUE)

svm_Radial <- train(Label~.,
                    data = features98Train[,-c(1,27:45)], #without names and lamda values
                    method="svmRadial",
                    trControl = trctrl_prob,
                    preProcess = c("center", "scale"),
                    tuneLength = 10)


rf_98 <- train(Label~.,
                    data = features98Train[,-c(1,27:45)], #without names and lamda values
                    method="rf",
                    trControl = trctrl_prob,
                    preProcess = c("center", "scale"),
                    tuneLength = 10)

```

```{r tune_model, eval=FALSE}
grid_for_98 <- expand.grid(sigma=seq(0.01,0.07,by=0.003), C=c(1:8))

svm_Radial98_tuned <- train(Label~.,
                    data = features98Train[,-c(1,27:45)], #without names and lamda values
                    method="svmRadial",
                    trControl = trctrl_prob,
                    preProcess = c("center", "scale"),
                    tuneGrid = grid_for_98)
```

```{r test_model, eval=FALSE}
test_pred <- predict(svm_Radial, features98Test)
confusionMatrix(test_pred, features98Test$Label, positive = "Tg")

#roc-auc
test_pred_prob <- predict(svm_Radial, features98Test, type = "prob")
roc(features98Test$Label, test_pred_prob$Tg)

#tuned svmmodel
test_pred <- predict(svm_Radial98_tuned, features98Test)
confusionMatrix(test_pred, features98Test$Label, positive = "Tg")

test_pred_prob <- predict(svm_Radial98_tuned, features98Test, type = "prob")
roc(features98Test$Label, test_pred_prob$Tg)

#rf model
test_pred <- predict(rf_98, features98Test)
confusionMatrix(test_pred, features98Test$Label, positive = "Tg")

```


```{r extract_rates}
#test_pred_prob <- predict(svm_Radial98_tuned, features98Test, type = "prob")
test_pred_prob <- readRDS("tmpdata/test_pred_prob_svmtuned98.rds")
features98Test <- readRDS("tmpdata/features98Test.rds")

actual <- as.data.frame(features98Test$Label)
names(actual) <- "actual"
prob_curve_prep <- cbind(test_pred_prob, actual)

p_threshold <- seq(0, 0.95, 0.05)

#True positive
TP <- vector("integer")
for (i in p_threshold) {
  TP <- c(TP, prob_curve_prep %>% filter((actual=="Tg")) %>% filter(Tg > i) %>% n_distinct())
}
TP

#False positive
FP <- vector("integer")
for (i in p_threshold) {
  FP <- c(FP, prob_curve_prep %>% filter((actual=="Bg")) %>% filter(Tg > i) %>% n_distinct())
}
FP

#True negative
TN <- vector("integer")
for (i in p_threshold) {
  TN <- c(TN, prob_curve_prep %>% filter((actual=="Bg")) %>% filter(Tg < i) %>% n_distinct())
}
TN

#False negative
FN <- vector("integer")
for (i in p_threshold) {
  FN <- c(FN, prob_curve_prep %>% filter((actual=="Tg")) %>% filter(Tg < i) %>% n_distinct())
}
FN

roc_data <- data.frame(TP, FP, TN, FN, p_threshold)

```

```{r plotting}
#convert to long format
roc_data_long <- roc_data %>% tidyr::gather("type", "value", 1:4)

ggplot(roc_data_long, aes(x=p_threshold, y=value)) + geom_point(aes(color = type)) 
ggplot(roc_data_long, aes(x=p_threshold, y=value)) + geom_line(aes(color = type)) 

ggplot(roc_data_long, aes(p_threshold,value)) + 
  geom_point(aes(color = type)) + 
  stat_smooth() +
  facet_wrap(~type)

```

```{r do_not_run, eval=FALSE}
# first loop attempts which do not work, why

for (p_threshold in seq(0, 0.95, 0.05)) {
  TP <- prob_curve_prep %>% filter((actual=="Tg")) %>% filter(Tg > p_threshold) %>% n_distinct()
  TP_column <- c(TP_column, TP) %>% as.data.frame() }


output <- vector("double", length(p_threshold))
for (p_threshold in seq(0, 0.95, 0.05)) {
  output <- prob_curve_prep %>% filter((actual=="Tg")) %>% filter(Tg > p_threshold) %>% n_distinct()
}

output <- vector("integer")
for (i in p_threshold) {
  output <- c(output,prob_curve_prep %>% filter((actual=="Tg")) %>% filter(Tg > i) %>% n_distinct())
}
output
```



