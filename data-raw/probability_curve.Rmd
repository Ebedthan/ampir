---
title: "Untitled"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(ampir)
library(caret)
library(tidyverse)
library(ggplot2)
library(pROC)
```

```{r read_and_prepare_data}
set.seed(396)
#read data
tg98 <- read_faa("tmpdata/amps_sp_ampdbs98.fasta")
tg98$Label <- "Tg"
bg98 <- read_faa("tmpdata/swissprot_all_MAY98.fasta")
bg98$Label <- "Bg"
#remove rows in bg that are in tg
bg98 <- bg98[!bg98$seq.aa %in% tg98$seq.aa,]
#remove nonstandard amino acids
tg98 <- remove_nonstandard_aa(tg98)
bg98 <- remove_nonstandard_aa(bg98)
#remove sequences shorter than 20 amino acids
tg98 <- tg98[nchar(tg98$seq.aa) >=20,]
bg98 <- bg98[nchar(bg98$seq.aa) >=20,]
#select the same number of rows as tg so databases are 1:1
bg98 <- bg98[sample(nrow(bg98),4981),]
#bind target and background datasets
bg_tg98 <- rbind(bg98, tg98)
#remove rownames
rownames(bg_tg98) <- NULL
#calculate features
features98 <- calculate_features(bg_tg98)
#add Label column for y variable
features98$Label <- bg_tg98$Label
#convert to factor
features98[["Label"]] <- factor(features98[["Label"]])
```

```{r train_model}
trainIndex <-createDataPartition(y=features98$Label, p=.8, list = FALSE)
features98Train <-features98[trainIndex,]
features98Test <-features98[-trainIndex,]

trctrl_prob <- trainControl(method = "repeatedcv", number = 10, repeats = 3, classProbs = TRUE)

svm_Radial <- train(Label~.,
                    data = features98Train[,-c(1,27:45)], #without names and lamda values
                    method="svmRadial",
                    trControl = trctrl_prob,
                    preProcess = c("center", "scale"),
                    tuneLength = 10)
```

```{r tune_model}
grid_for_98 <- expand.grid(sigma=seq(0.01,0.07,by=0.003), C=c(1:8))

svm_Radial98_tuned <- train(Label~.,
                    data = features98Train[,-c(1,27:45)], #without names and lamda values
                    method="svmRadial",
                    trControl = trctrl_prob,
                    preProcess = c("center", "scale"),
                    tuneGrid = grid_for_98)
```

```{r test_model}
test_pred <- predict(svm_Radial, features98Test)
cm <- confusionMatrix(test_pred, features98Test$Label, positive = "Tg")
cm
#roc-auc
test_pred_prob <- predict(svm_Radial, features98Test, type = "prob")
roc(features98Test$Label, test_pred_prob$Tg)
```

```{r extract_rates}
rates <- as.data.frame(cm[["byClass"]])

test_pred_prob <- predict(svm_Radial, features98Test, type = "prob")
rate_50 <- t(as.data.frame(cm[["byClass"]]))[,1:2]

svm_pred_class <- predict(svm_Radial)
svm_pred_prob <- predict(svm_Radial, type = "prob")


extractProb(svm_Radial, testX = features98Test[,2:26])
```

```{r}
test_pred_prob <- predict(svm_Radial, features98Test, type = "prob")
actual <- as.data.frame(features98Test$Label)
names(actual) <- "actual"

prob_curve_prep <- cbind(test_pred_prob, actual, prob_50)


#true positive rate = TP/actual yes 

table(prob_curve_prep$actual) # bg: 996 tg: 996
table(prob_curve_prep$`prob_curve_prep$Tg >= 0.5`) # bg: 1042 tg: 950

TP_rate <- 1042/

prob_curve_prep <- cbind(test_pred_prob, actual, prob_50, prob_70, prob_90)

prob_50 <- as.data.frame(prob_curve_prep$Tg >= 0.50)
#change falsevalues to 0
prob_curve_prep$`prob_curve_prep$Tg >= 0.5`[grep(FALSE, prob_50$`prob_curve_prep$Tg >= 0.5`)] <- 0


prob_70 <- as.data.frame(as.numeric(prob_curve_prep$Tg >= 0.70))

prob_90 <- as.data.frame(prob_curve_prep$Tg >= 0.90)
```

```{r}
for (i in seq(0.01, 0.95, 0.05)) {
  prob_curve_prep >= 
}
```

